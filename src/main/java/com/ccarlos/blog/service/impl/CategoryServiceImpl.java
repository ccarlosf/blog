package com.ccarlos.blog.service.impl;

import com.ccarlos.blog.common.CodeMessage;
import com.ccarlos.blog.common.JsonResponse;
import com.ccarlos.blog.common.ResponseCode;
import com.ccarlos.blog.dao.CategoryMapper;
import com.ccarlos.blog.exception.GlobalException;
import com.ccarlos.blog.model.Category;
import com.ccarlos.blog.service.CategoryService;
import org.apache.commons.collections.CollectionUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;

/**
 * @description: 分类服务实现
 * @author: ccarlos
 * @date: 2019/5/30 19:13
 */
@Service
public class CategoryServiceImpl implements CategoryService {

	@Autowired
	private CategoryMapper categoryMapper;

	/**
	 * @description: 添加分类
	 * @author: ccarlos
	 * @date: 2019/5/30 19:39
	 * @param: category 分类对象
	 * @return: com.ccarlos.blog.common.JsonResponse<java.lang.String>
	 */
	@Override
	@Transactional
	public JsonResponse<String> addCategory(Category category) {
		// 判断当前用户是否已经添加了相同名字的分类
		List<Category> categoryList = categoryMapper.selectCategoryListByUserId(category.getCategoryName(), category.getUserId());
		if (CollectionUtils.isNotEmpty(categoryList)) {
			throw new GlobalException(CodeMessage.CATEGORY_USER_EXIST);
		}
		category.setCreateTime(new Date());
		category.setUpdateTime(new Date());
		int resultCount = categoryMapper.insert(category);
		if (resultCount > 0) {
			return JsonResponse.createBySuccessMessage("添加分类成功");
		}
		return JsonResponse.createByErrorMessage("添加分类失败");
	}

	/**
	 * @description: 根据用户id获取分类列表
	 * @author: ccarlos
	 * @date: 2019/5/31 10:34
	 * @param: userId 用户id
	 * @return: com.ccarlos.blog.common.JsonResponse<java.util.List                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               com.ccarlos.blog.model.Category>>
	 */
	@Override
	public JsonResponse<List<Category>> getCategoryList(Long userId) {
		List<Category> categoryList = categoryMapper.selectCategoryListByUserId(null, userId);
//		List<Category> categoryList1 = categoryMapper.selectCategoryListByUserId("", userId);
		return JsonResponse.createBySuccess(categoryList);
	}

	/**
	 * @description: 根据id删除分类
	 * @author: ccarlos
	 * @date: 2019/5/31 15:56
	 * @param: id 分类id
	 * @return: com.ccarlos.blog.common.JsonResponse<java.lang.String>
	 */
	@Override
	@Transactional
	public JsonResponse<String> removeCategory(Long id) {
		int resultCount = categoryMapper.deleteByPrimaryKey(id);
		if (resultCount == 0) {
			return JsonResponse.createBySuccessMessage("删除分类失败");
		}
		return JsonResponse.createBySuccessMessage("删除分类成功");
	}

	/**
	 * @description: 根据分类id获取分类信息
	 * @author: ccarlos
	 * @date: 2019/6/2 11:06
	 * @param: id 分类id
	 * @return: com.ccarlos.blog.common.JsonResponse<com.ccarlos.blog.model.Category>
	 */
	@Override
	public JsonResponse<Category> getCategoryById(Long id) {
		if (id == null) {
			return JsonResponse.createByErrorCodeMessage(ResponseCode.ILLEGAL_ARGUMENT.getCode(), ResponseCode.ILLEGAL_ARGUMENT.getDesc());
//			return JsonResponse.createByErrorCodeMessage(CodeMessage.CATEGORY_ID_NULL.getCode(),CodeMessage.CATEGORY_ID_NULL.getMessage());
		}
		Category category = categoryMapper.selectByPrimaryKey(id);
		if (category == null) {
			return JsonResponse.createByErrorMessage("该分类不存在");
		}
		return JsonResponse.createBySuccess(category);
	}

	/**
	 * @description:
	 * @author: ccarlos
	 * @date: 2019/6/2 11:42
	 * @param: category
	 * @return: com.ccarlos.blog.common.JsonResponse<java.lang.String>
	 * @throws:
	 */
	@Override
	@Transactional
	public JsonResponse<String> modifyCategory(Category category) {
		category.setUpdateTime(new Date());
		int resultCount = categoryMapper.updateByPrimaryKeySelective(category);
		if (resultCount == 0) {
			return JsonResponse.createByErrorMessage("修改分类失败");
		}
		return JsonResponse.createBySuccessMessage("修改分类成功");
	}
}
